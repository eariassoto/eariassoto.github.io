
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Source-to-source Compilation With Lex-Yacc - Emmanuel Arias</title>
  <meta name="author" content="Emmanuel Arias">

  
  <meta name="description" content="A source-to-source compiler is a compiler that takes a program written in a certain language and outputs the equivalent program in another language. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://eariassoto.github.io/blog/2017/05/01/source-to-source-compilation-with-lex-yacc">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Emmanuel Arias" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300" rel="stylesheet"> 
<!--- MathJax Configuration -->
<script type="text/javascript" src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-55905821-2', 'auto');
    ga('send', 'pageview');

  </script>



</head>

<body   class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Emmanuel Arias</a></h1>
  
    <h2>Software developer</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscribe" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 13.310204,73.332654 C 5.967347,73.332654 0,79.322448 0,86.621428 c 0,7.338776 5.967347,13.262246 13.310204,13.262246 7.370408,0 13.328572,-5.92245 13.328572,-13.262246 0,-7.29898 -5.958164,-13.288774 -13.328572,-13.288774 z M 0.01530612,33.978572 V 53.143878 C 12.493878,53.143878 24.229592,58.02347 33.068368,66.865306 41.894898,75.685714 46.767346,87.47449 46.767346,100 h 19.25 C 66.017346,63.592858 36.4,33.979592 0.01530612,33.978572 l 0,0 z M 0.03877552,0 V 19.17449 C 44.54796,19.17551 80.77551,55.437756 80.77551,100 H 100 C 100,44.87653 55.15102,0 0.03877552,0 z"></path></svg></a></li>
  
</ul>
  
  
  
  
  
<ul class="subscribe">
  <li><a href="https://github.com/eariassoto" rel="subscribe-github" title="@eariassoto on GitHub" target="_blank"><svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="25" height="25" viewbox="0 0 100 100"><path class="social" d="M 50,0 C 22.385714,0 0,22.385714 0,50 0,77.614286 22.385714,100 50,100 77.614286,100 100,77.614286 100,50 100,22.385714 77.614286,0 50,0 z m 29.692858,79.692858 c -3.859184,3.859182 -8.351022,6.887754 -13.35,9.00306 -1.27041,0.536736 -2.560204,1.009184 -3.867348,1.415306 v -7.493878 c 0,-3.938774 -1.35102,-6.835714 -4.053062,-8.690816 1.692858,-0.163264 3.24694,-0.390816 4.663266,-0.683672 1.416326,-0.292858 2.913266,-0.716328 4.491838,-1.27041 1.57857,-0.55408 2.994896,-1.213264 4.247958,-1.97755 1.253062,-0.765306 2.458164,-1.758164 3.613266,-2.978572 1.155102,-1.220408 2.12449,-2.604082 2.905102,-4.15 0.780612,-1.545918 1.4,-3.40204 1.855102,-5.566326 0.455102,-2.164286 0.683674,-4.54898 0.683674,-7.153062 0,-5.045918 -1.643878,-9.341836 -4.931634,-12.890816 C 77.44796,33.35 77.285714,29.10204 75.463266,24.512244 l -1.22143,-0.145918 c -0.845918,-0.09796 -2.368366,0.260204 -4.565306,1.07449 -2.196938,0.814286 -4.663264,2.14796 -7.396938,4.004082 -3.87449,-1.07449 -7.893878,-1.611224 -12.061224,-1.611224 -4.19898,0 -8.203062,0.536734 -12.012246,1.611224 -1.72449,-1.17245 -3.361224,-2.139796 -4.907142,-2.905102 C 31.753062,25.77449 30.516326,25.254082 29.587756,24.97653 28.660204,24.7 27.79796,24.528572 27,24.463266 c -0.79796,-0.0653 -1.310204,-0.08062 -1.537756,-0.04898 -0.22755,0.03164 -0.390816,0.0653 -0.487754,0.09796 -1.82347,4.62245 -1.985714,8.87143 -0.487756,12.743878 -3.287754,3.54796 -4.931632,7.844898 -4.931632,12.890816 0,2.604082 0.227552,4.988776 0.683674,7.153062 0.456122,2.164286 1.07449,4.020408 1.855102,5.566326 0.780612,1.545918 1.75,2.929592 2.905102,4.15 1.155102,1.220408 2.360204,2.213266 3.613264,2.978572 1.253062,0.766326 2.669388,1.42449 4.24796,1.97755 1.578572,0.554082 3.07551,0.976532 4.491836,1.27041 1.416328,0.292856 2.970408,0.521428 4.663266,0.683672 -2.669388,1.82347 -4.004082,4.720408 -4.004082,8.690816 v 7.639796 C 36.536734,89.818368 35.083674,89.3 33.656122,88.695918 c -4.99898,-2.115306 -9.490816,-5.143878 -13.35,-9.00306 -3.859184,-3.859184 -6.887754,-8.351022 -9.00306,-13.35 C 9.1163263,61.171428 8.0071428,55.67347 8.0071428,50 c 0,-5.67347 1.1091835,-11.171428 3.2969392,-16.342858 2.115306,-4.998978 5.143878,-9.490816 9.00306,-13.35 3.859184,-3.859182 8.351022,-6.887754 13.35,-9.00306 C 38.828572,9.1163266 44.32653,8.0071428 50,8.0071428 c 5.67347,0 11.171428,1.1091838 16.342858,3.2969392 5,2.115306 9.490816,5.143878 13.35,9.00306 3.859182,3.859184 6.887754,8.351022 9.00306,13.35 2.186736,5.17245 3.295918,10.67041 3.295918,16.342858 0,5.672448 -1.109182,11.171428 -3.296938,16.342858 -2.115306,4.998978 -5.143878,9.490816 -9.00204,13.35 l 0,0 z"></path></svg></a></li>
</ul>
  
  
  
  
  
  
  
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      
        <h1 class="entry-title">Source-to-source Compilation With Lex-Yacc</h1>
      
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-05-01T18:38:55-06:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>6:38 pm</span></time>
        
        
      </p>
    
  </header>


<div class="entry-content"><p>A source-to-source compiler is a compiler that takes a program written in a certain language and outputs the equivalent program in another language. This process is useful to compile a program to an intermediate language, or provide backward compatibility for a legacy language. The Babel compiler, for instance, can parse Javascript ES6 to Javascript ES5 standard. The ES6 standard comes with a lot of improvements and new features, but it is currently not supported by most web browsers. Or maybe, you can come up with a new language and translate it to another one. Take for example this list of <a href="https://github.com/jashkenas/coffeescript/wiki/list-of-languages-that-compile-to-js">languages that compile to Javascript</a>.</p>

<p>In this post, I will describe a source-to-source compiler that transforms Brainfuck program into its equivalent 64 bits assembly code. The output assembly program can be built into a executable, thus allowing you to run Brainfuck programs natively.</p>

<!--more-->


<p><a class=button href="https://github.com/eariassoto/brasm/" target="%5fblank">Get the code on GitHub</a></p>

<h1>Requirements</h1>

<p>I used Python to develop the compiler. In order to run the compiler you need to have Python installed on your computer. Also, you need the Python Lex-Yacc (PLY) module installed in your python environment. You can download the latest PLY version (I used the 3.10 version) from the <a href="http://www.dabeaz.com/ply/">PLY homepage</a>. To install PLY uncompress the file you downloaded, open a terminal within the uncompressed folder and run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo python setup.py install
</span></code></pre></td></tr></table></div></figure>


<p>In case you want to compile the assembly code, you need the <a href="http://www.nasm.us/">NASM assembler</a> and the Linux dynamic linker (ld command). I decided to go with NASM because it supports the Intel assembly syntax, which is more readable than the AT&amp;T syntax.</p>

<h1>The source language: Brainfuck</h1>

<p>Brainfuck is a simple language, yet <a href="https://en.wikipedia.org/wiki/Turing_completeness">Turing complete</a> programming language. It has a small set of instructions and was inspired by how the Turing machine works. Its only memory structure is a buffer of at least 30,000 bytes initialized to zero. In C, that buffer can be declared as <code>char buffer[30000] = {0};</code>. The only variable is a data pointer that starts at the beginning of the buffer. To continue the C analogy, the data pointer might be declared as <code>char *ptr = buffer;</code></p>

<p>A Brainfuck program is structured as a series of instructions. The most basic instructions manipulate memory buffer using the data pointer. There are two streams of bytes for input and output. Also, there are two instructions to implement loops. Table below describes all the instructions:</p>

<table>
<thead>
<tr>
<th> Command </th>
<th style="text-align:center;"> Description </th>
<th style="text-align:right;"> C equivalent </th>
</tr>
</thead>
<tbody>
<tr>
<td> > </td>
<td style="text-align:center;"> Increment data pointer </td>
<td style="text-align:right;"> ++ptr; </td>
</tr>
<tr>
<td> &lt; </td>
<td style="text-align:center;"> Decrement data pointer </td>
<td style="text-align:right;"> &ndash;ptr; </td>
</tr>
<tr>
<td> + </td>
<td style="text-align:center;"> Increment by one byte at the data pointer </td>
<td style="text-align:right;"> ++*ptr; </td>
</tr>
<tr>
<td> - </td>
<td style="text-align:center;"> Decrement by one byte at the data pointer </td>
<td style="text-align:right;"> &ndash;*ptr; </td>
</tr>
<tr>
<td> . </td>
<td style="text-align:center;"> Print byte at the data pointer </td>
<td style="text-align:right;"> putchar(*ptr); </td>
</tr>
<tr>
<td> , </td>
<td style="text-align:center;"> Read char from input, store in the byte at the data pointer</td>
<td style="text-align:right;"> *ptr=getchar(); </td>
</tr>
<tr>
<td> [ </td>
<td style="text-align:center;"> If the byte at the data pointer is zero, jump to matching <code>]</code> </td>
<td style="text-align:right;"> while (*ptr) { </td>
</tr>
<tr>
<td> ] </td>
<td style="text-align:center;"> if the byte at the data pointer is nonzero, jump to matching <code>[</code> </td>
<td style="text-align:right;"> } </td>
</tr>
</tbody>
</table>


<p>Brainfuck falls into the category of <a href="https://en.wikipedia.org/wiki/Esoteric_programming_language">esoteric programming languages</a>. So, Brainfuck programs are really hard to understand. As example, this is an implementation of the classic &ldquo;Hello World&rdquo; program written in Brainfuck:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>++++++++++<span class="o">[</span>&gt;+++++++&gt;++++++++++&gt;+++&gt;+<span class="o">&lt;&lt;&lt;</span>&lt;-<span class="o">]</span>
</span><span class='line'>&gt;++.&gt;+.+++++++..+++.&gt;++.&lt;&lt;+++++++++++++++.&gt;.+++.------.--------.&gt;+.&gt;.
</span></code></pre></td></tr></table></div></figure>


<h1>Hello Assembly</h1>

<p>For this post, I will assume you are familiarized with x86-64 assembly code. To compare the previous example, I wrote a Hello World in x86-64 assembly code.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">global</span> <span class="no">_start</span>
</span><span class='line'>
</span><span class='line'><span class="nf">section</span> <span class="no">.text</span>
</span><span class='line'><span class="nl">_start:</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">message</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="mi">13</span>
</span><span class='line'><span class="nf">syscall</span>
</span><span class='line'>
</span><span class='line'><span class="nf">mov</span> <span class="no">eax</span><span class="p">,</span> <span class="mi">60</span>
</span><span class='line'><span class="nf">xor</span> <span class="no">rdi</span><span class="p">,</span> <span class="no">rdi</span>
</span><span class='line'><span class="nf">syscall</span>
</span><span class='line'>
</span><span class='line'><span class="nl">message:</span>
</span><span class='line'><span class="nf">db</span> <span class="err">&quot;</span><span class="no">Hello</span><span class="p">,</span> <span class="no">World</span><span class="err">&quot;</span><span class="p">,</span> <span class="mi">10</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>global _start</code> directive defines the entry point for our program. The <code>.text</code> section contains the program instructions and all constants we defined. This program calls the <code>sys_write</code> system call to print the string <code>"Hello World"</code> and the <code>sys_exit</code> system call to exit the program. System calls are invoked using the <code>syscall</code> instruction, having all the system call parameters set first. To check all the available system calls and their parameters, <a href="http://blog.rchapman.org/posts/Linux_System_Call_Table_for_x86_64/">check this list</a>.</p>

<h1>Translating Brainfuck instructions set to x64 assembly</h1>

<p>The first thing I needed to define was the buffer memory and the data pointer. I declared the buffer as a 30000 bytes zero-initialized array in the <code>.bss</code> section. In this section the program declared static variables. These variables will be allocated and initialized by the program loader. All variables in the <code>.bss</code> section are zero-initialized. For the data pointer, I will use register <code>r9</code>. When the program starts, the buffer address will be stored in this register.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">section</span> <span class="no">.bss</span>
</span><span class='line'><span class="nl">buffer:</span> <span class="nf">resb</span> <span class="mi">30000</span>
</span><span class='line'>
</span><span class='line'><span class="nl">_start:</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">r9</span><span class="p">,</span> <span class="no">buffer</span>
</span></code></pre></td></tr></table></div></figure>


<p>I will break Brainfuck instructions into four subsections: pointer instructions, data instructions, input/output instructions and the loop instruction.</p>

<h2>Pointer instructions</h2>

<p>Instructions <code>&gt;</code> and <code>&lt;</code> move the data pointer through the buffer. For this task, address in register <code>r9</code> should move eight positions (so the address moves a byte) forward or backwards.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">;</span> <span class="err">&gt;</span> <span class="nf">move</span> <span class="no">data</span> <span class="no">pointer</span> <span class="no">forward</span>
</span><span class='line'><span class="nf">add</span> <span class="no">r9</span><span class="p">,</span> <span class="mi">8</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="err">&lt;</span> <span class="nf">move</span> <span class="no">data</span> <span class="no">pointer</span> <span class="no">backward</span>
</span><span class='line'><span class="nf">sub</span> <span class="no">r9</span><span class="p">,</span> <span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Data instructions</h2>

<p>Here, the byte stored in the address in register <code>r9</code> is modified using a temporary register, <code>r10b</code>. Then, the result value is stored back into the same address.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="err">;</span> <span class="err">+</span> <span class="nf">add</span> <span class="mi">1</span> <span class="no">to</span> <span class="no">byte</span> <span class="no">at</span> <span class="no">data</span> <span class="no">pointer</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">byte</span> <span class="no">r10b</span><span class="p">,</span> <span class="err">[</span><span class="no">r9</span><span class="err">]</span>
</span><span class='line'><span class="nf">add</span> <span class="no">r10b</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">byte</span> <span class="err">[</span><span class="no">r9</span><span class="err">]</span><span class="p">,</span> <span class="no">r10b</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="err">-</span> <span class="nf">subtract</span> <span class="mi">1</span> <span class="no">to</span> <span class="no">byte</span> <span class="no">at</span> <span class="no">data</span> <span class="no">pointer</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">byte</span> <span class="no">r10b</span><span class="p">,</span> <span class="err">[</span><span class="no">r9</span><span class="err">]</span>
</span><span class='line'><span class="nf">sub</span> <span class="no">r10b</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">byte</span> <span class="err">[</span><span class="no">r9</span><span class="err">]</span><span class="p">,</span> <span class="no">r10b</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Input/Output instructions</h2>

<p>To provide the input and output data streams, I used system calls. These are functions provided and executed by the kernel that allow a program to interact with higher level functionality. To request a system call to the kernel, register <code>rax</code> must have the system call id number. Some system calls may take parameters from specific registers. The compiler uses the <code>sys_write</code> and <code>sys_read</code> system calls to read and write from <code>stdin</code> and <code>stdout</code> respectively.</p>

<p>The <code>_print_byte</code> function prints an input byte on <code>stdout</code>. Input byte must be store on the register <code>rcx</code>. The function pushes the register <code>rcx</code> into the stack. Then, it prepares the registers needed by the system call <code>sys_write</code>. Register <code>rdi</code> contains the file descriptor, in this case <code>stdout</code> file descriptor is <code>1</code>. Register <code>rsi</code> has the address of the content to be written, in our case the stack address. Register <code>rdx</code> has the length of the buffer. Finally, register <code>rax</code> contains the system call id, for <code>sys_write</code> the id is <code>1</code>. Before calling <code>_print_byte</code> function, the program will store on register <code>cl</code> (lowest byte in register <code>rcx</code>) the byte at data pointer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nl">_print_byte:</span>
</span><span class='line'><span class="nf">push</span> <span class="no">rcx</span> <span class="err">;</span> <span class="no">grow</span> <span class="no">stack</span> <span class="no">and</span> <span class="no">push</span> <span class="no">output</span> <span class="no">byte</span> <span class="no">to</span> <span class="no">stack</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">1</span> <span class="err">;</span> <span class="no">file</span> <span class="no">descriptor</span> <span class="mi">1</span> <span class="no">is</span> <span class="no">stdout</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rsp</span> <span class="err">;</span> <span class="no">stack</span> <span class="no">address</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="mi">1</span> <span class="err">;</span> <span class="no">number</span> <span class="no">of</span> <span class="no">bytes</span> <span class="no">to</span> <span class="no">print</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">1</span> <span class="err">;</span> <span class="no">system</span> <span class="no">call</span> <span class="mi">1</span> <span class="no">is</span> <span class="no">write</span>
</span><span class='line'><span class="nf">syscall</span> <span class="err">;</span> <span class="no">call</span> <span class="no">OS</span> <span class="no">system</span> <span class="no">call</span>
</span><span class='line'><span class="nf">pop</span> <span class="no">rcx</span> <span class="err">;</span> <span class="no">decrease</span> <span class="no">stack</span>
</span><span class='line'><span class="nf">ret</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="err">.</span> <span class="nf">call</span> <span class="no">_print_byte</span> <span class="no">function</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">cl</span><span class="p">,</span> <span class="err">[</span><span class="no">r9</span><span class="err">]</span>
</span><span class='line'><span class="nf">call</span> <span class="no">_print_byte</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>_read_byte</code> function is very similar to the <code>_print_byte</code> function. The <code>sys_read</code> system calls, the only difference is that <code>sys_read</code> id number is <code>0</code> and the file descriptor for <code>stdin</code> is also <code>0</code>. After calling <code>_read_byte</code> function, the program stores the byte returned by <code>_read_byte</code> on <code>cl</code> at data pointer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nl">_read_byte:</span>
</span><span class='line'><span class="nf">sub</span> <span class="no">rsp</span><span class="p">,</span> <span class="mi">8</span> <span class="err">;</span> <span class="no">grow</span> <span class="no">stack</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rsi</span><span class="p">,</span> <span class="no">rsp</span> <span class="err">;</span> <span class="no">stack</span> <span class="no">address</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdi</span><span class="p">,</span> <span class="mi">0</span> <span class="err">;</span> <span class="no">file</span> <span class="no">descriptor</span> <span class="mi">0</span> <span class="no">is</span> <span class="no">stdin</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rdx</span><span class="p">,</span> <span class="mi">1</span> <span class="err">;</span> <span class="no">number</span> <span class="no">of</span> <span class="no">bytes</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">rax</span><span class="p">,</span> <span class="mi">0</span> <span class="err">;</span> <span class="no">syscall</span> <span class="mi">0</span> <span class="no">is</span> <span class="no">read</span>
</span><span class='line'><span class="nf">syscall</span> <span class="err">;</span> <span class="no">call</span> <span class="no">OS</span> <span class="no">system</span> <span class="no">call</span>
</span><span class='line'><span class="nf">pop</span> <span class="no">rcx</span> <span class="err">;</span> <span class="no">decrease</span> <span class="no">stack</span> <span class="no">and</span> <span class="no">save</span> <span class="no">input</span>
</span><span class='line'><span class="nf">ret</span>
</span><span class='line'>
</span><span class='line'><span class="err">;</span> <span class="err">,</span> <span class="nf">call</span> <span class="no">_read_byte</span> <span class="no">function</span>
</span><span class='line'><span class="nf">call</span> <span class="no">_read_byte</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">byte</span> <span class="err">[</span><span class="no">r9</span><span class="err">]</span><span class="p">,</span> <span class="no">cl</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Loop instruction</h2>

<p>The instructions <code>[</code> and <code>]</code> are the C equivalent of <code>while (*ptr) { }</code>. The assembly loop jumps into the comparison between the byte at data pointer and zero. If the value is not zero, the program jumps to the <code>_cloop</code> tag. Between the <code>_cloop</code> and <code>_loop</code> tags, the compiler will put all the parsed Brainfuck code that was originally between <code>[</code> and <code>]</code> instructions.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='asm'><span class='line'><span class="nf">jmp</span> <span class="no">_loop0</span>
</span><span class='line'><span class="nl">_cloop0:</span>
</span><span class='line'><span class="err">;</span> <span class="err">[</span><span class="nf">loop</span> <span class="no">code</span><span class="err">]</span>
</span><span class='line'><span class="nl">_loop0:</span>
</span><span class='line'><span class="nf">mov</span> <span class="no">byte</span> <span class="no">cl</span><span class="p">,</span> <span class="err">[</span><span class="no">r9</span><span class="err">]</span>
</span><span class='line'><span class="nf">cmp</span> <span class="no">cl</span><span class="p">,</span> <span class="mi">0</span>
</span><span class='line'><span class="nf">jne</span> <span class="no">_cloop0</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Building the compiler</h1>

<p>Compiling a program can be described, in a very basic way, as a two parts process:</p>

<ol>
<li>Break the input program into the language components.</li>
<li>Build the program using the language components and the language specification.</li>
</ol>


<p>This is where Lex-Yacc comes to use. Lex will help us parsing the input program from a series of characters to strings with certain meaning, called tokens. This process is known as lexical analysis. Yacc will generate a parser from a grammar. The parser will take the tokens and try to find a valid match for the grammar. In this process, the grammar rules will trigger actions that will create the output code.</p>

<h2>Lexical analysis</h2>

<p>Here, I will go into details about what the PLY Lex implementation needs to build a lexical analyzer. First thing, Lex requires a list of token names. I defined one token for each Brainfuck instruction.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">tokens</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'><span class="s">&#39;INCR_PTR&#39;</span><span class="p">,</span> <span class="s">&#39;DECR_PTR&#39;</span><span class="p">,</span> <span class="s">&#39;INCR_VAL&#39;</span><span class="p">,</span> <span class="s">&#39;DECR_VAL&#39;</span><span class="p">,</span> <span class="s">&#39;WRITE&#39;</span><span class="p">,</span> <span class="s">&#39;READ&#39;</span><span class="p">,</span> <span class="s">&#39;LB&#39;</span><span class="p">,</span> <span class="s">&#39;RB&#39;</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each token needs a rule to match the input with the token. Rules are defined as functions named as the token with the prefix <code>t_</code>. Some rules are simple and they can be defined as regular expressions. Because Brainfuck instructions are just one character, I defined simple rules for their tokens.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Simple Tokens</span>
</span><span class='line'><span class="n">t_INCR_PTR</span> <span class="o">=</span> <span class="s">r&#39;\&gt;&#39;</span>
</span><span class='line'><span class="n">t_DECR_PTR</span> <span class="o">=</span> <span class="s">r&#39;\&lt;&#39;</span>
</span><span class='line'><span class="n">t_INCR_VAL</span> <span class="o">=</span> <span class="s">r&#39;\+&#39;</span>
</span><span class='line'><span class="n">t_DECR_VAL</span> <span class="o">=</span> <span class="s">r&#39;\-&#39;</span>
</span><span class='line'><span class="n">t_WRITE</span> <span class="o">=</span> <span class="s">r&#39;\.&#39;</span>
</span><span class='line'><span class="n">t_READ</span> <span class="o">=</span> <span class="s">r&#39;\,&#39;</span>
</span><span class='line'><span class="n">t_LB</span> <span class="o">=</span> <span class="s">r&#39;\[&#39;</span>
</span><span class='line'><span class="n">t_RB</span> <span class="o">=</span> <span class="s">r&#39;\]&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">t_ignore</span> <span class="o">=</span> <span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span> <span class="c"># Ignored characters</span>
</span></code></pre></td></tr></table></div></figure>


<p>Some rules need to perform an action for every token they find. For example, I will set a rule to count the number of lines, in case I want to indicate the line number in a compilation error. Also, I will treat any other characters the input program might have as comments.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">t_newline</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span class='line'>  <span class="s">r&#39;\n+&#39;</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">lineno</span> <span class="o">+=</span> <span class="n">t</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">t_error</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&quot;&quot;&quot; Ignore all other characters &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="n">t</span><span class="o">.</span><span class="n">lexer</span><span class="o">.</span><span class="n">skip</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>With these, we can tell Lex to build the lexical analyzer.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Build the lexer</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">ply.lex</span> <span class="kn">as</span> <span class="nn">lex</span>
</span><span class='line'><span class="n">lex</span><span class="o">.</span><span class="n">lex</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Parsing the tokens</h2>

<p>Yacc will generate our parser based on a <a href="https://en.wikipedia.org/wiki/Backus%E2%80%93Naur_form">Backusâ€“Naur form (BNF) grammar</a>. The grammar I used is simple because Brainfuck programs are just a sequence of valid instructions. I defined two types of instructions: simple instructions (<code>&gt; &lt; + - . ,</code>) and loops (<code>[ ]</code>). Loops are treated as a different type of instructions because Brainfuck allows nested loops. The entire grammar is specified below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">program</span> <span class="p">:</span> <span class="n">instruction</span>
</span><span class='line'>
</span><span class='line'><span class="n">instruction</span> <span class="p">:</span> <span class="n">simpleInstruction</span>
</span><span class='line'><span class="o">|</span> <span class="n">loopInstruction</span>
</span><span class='line'><span class="o">|</span> <span class="n">simpleInstruction</span> <span class="n">instruction</span>
</span><span class='line'><span class="o">|</span> <span class="n">loopInstruction</span> <span class="n">instruction</span>
</span><span class='line'>
</span><span class='line'><span class="n">loopInstruction</span> <span class="p">:</span> <span class="n">LB</span> <span class="n">instruction</span> <span class="n">RB</span>
</span><span class='line'>
</span><span class='line'><span class="n">simpleInstruction</span> <span class="p">:</span> <span class="n">INCR_PTR</span>
</span><span class='line'><span class="o">|</span> <span class="n">DECR_PTR</span>
</span><span class='line'><span class="o">|</span> <span class="n">INCR_VAL</span>
</span><span class='line'><span class="o">|</span> <span class="n">DECR_VAL</span>
</span><span class='line'><span class="o">|</span> <span class="n">WRITE</span>
</span><span class='line'><span class="o">|</span> <span class="n">READ</span>
</span></code></pre></td></tr></table></div></figure>


<p>Grammar rules are defined in Yacc as functions. These functions need the prefix <code>p_</code> and take one parameter named <code>p</code>. <code>p</code> is an array containing the values of each grammar symbol in the corresponding rule. The rule is written in a triple quote comment after the function definition. The function body will be the actions that the rule will perform if it founds a match. Rules that are reduced should save in <code>p[0]</code> the final result.</p>

<p>The first rule defined will be the starting point for the parse. These is the starting rule for my compiler:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">p_program</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&#39;&#39;&#39; program : instructions &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="k">global</span> <span class="n">global_success</span>
</span><span class='line'>  <span class="n">compile_program</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>  <span class="n">global_success</span> <span class="o">=</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>This rule will take all instructions, if found, and translate them into the assembly equivalents. The <code>compile_program</code> function will replace Brainfuck operations into assembly instructions and save the result on a file. The next rules reduce all the instructions into the final <code>instructions</code> symbol.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">p_instructions_expansion</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&#39;&#39;&#39; instructions : simpleInstruction instructions</span>
</span><span class='line'><span class="sd">  | loop_instruction instructions</span>
</span><span class='line'><span class="sd">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p_instructions</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&#39;&#39;&#39; instructions : simpleInstruction</span>
</span><span class='line'><span class="sd">  | loop_instruction</span>
</span><span class='line'><span class="sd">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The rules to match the instructions will reduce the instruction within a wrapper structure. The wrapper will store the instruction type and the instruction (or instructions in case it is a loop).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">make_instruction_action</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&quot;&quot;&quot; Wraps the instruction content into a struct &quot;&quot;&quot;</span>
</span><span class='line'>  <span class="n">obj</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">obj</span><span class="p">[</span><span class="n">INSTR_OBJ_PROP_TYPE</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span>
</span><span class='line'>  <span class="n">obj</span><span class="p">[</span><span class="n">INSTR_OBJ_PROP_PAYLOAD</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">obj</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p_loop_instruction</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&#39;&#39;&#39; loop_instruction : LB instructions RB</span>
</span><span class='line'><span class="sd">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="n">action</span> <span class="o">=</span> <span class="n">make_instruction_action</span><span class="p">(</span><span class="s">&#39;loop&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</span><span class='line'>  <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">p_simple_instruction</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span class='line'>  <span class="sd">&#39;&#39;&#39;simpleInstruction : INCR_PTR</span>
</span><span class='line'><span class="sd">  | DECR_PTR</span>
</span><span class='line'><span class="sd">  | INCR_VAL</span>
</span><span class='line'><span class="sd">  | DECR_VAL</span>
</span><span class='line'><span class="sd">  | WRITE</span>
</span><span class='line'><span class="sd">  | READ</span>
</span><span class='line'><span class="sd">  &#39;&#39;&#39;</span>
</span><span class='line'>  <span class="n">action</span> <span class="o">=</span> <span class="n">make_instruction_action</span><span class="p">(</span><span class="s">&#39;op&#39;</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>  <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>I also defined a rule in case the parser encounters a error in the input program.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">p_error</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">p</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Syntax error at &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span><span class="p">:</span>
</span><span class='line'>  <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error, input program empty.&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally, I just need to build the parser and give the compiler a starting point.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">ply.yacc</span> <span class="kn">as</span> <span class="nn">yacc</span>
</span><span class='line'><span class="n">yacc</span><span class="o">.</span><span class="n">yacc</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</span><span class='line'>  <span class="k">global</span> <span class="n">global_compiled_filename</span>
</span><span class='line'>  <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
</span><span class='line'>  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;file&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;Brainfuck input file to be parsed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&quot;-o&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s">&quot;file name for the output assembly code&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">o</span><span class="p">:</span>
</span><span class='line'>    <span class="n">global_compiled_filename</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">o</span>
</span><span class='line'>  <span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">program_str</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</span><span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">yacc</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">program_str</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">global_success</span><span class="p">):</span>
</span><span class='line'>      <span class="k">print</span><span class="p">(</span><span class="s">&quot;Program compiled. To build the executable run:</span><span class="se">\</span>
</span><span class='line'><span class="s">      </span><span class="se">\n\t</span><span class="s">nasm -f elf64 {0}.asm &amp;&amp; ld {0}.o -o {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">global_compiled_filename</span><span class="p">))</span>
</span><span class='line'>  <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
</span><span class='line'>  <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s">&#39;Error, input file not found!&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Improvement proposals</h1>

<ul>
<li>Optimize the compiler. Group pointer and data instructions to no repeat a lot of assembly code.</li>
<li>Support reading/writing files. Perhaps the memory buffer can be loaded from/saved into a file.</li>
<li>Extend Brainfuck specification to support variables and string constants.

<h2>Bigger challenge</h2></li>
<li>Create a compiler to translate a subset of the C language to Brainfuck. Then use this compiler to translate the Brainfuck code into assembly. Brainfuck as an intermediate language.</li>
</ul>


<p><a class=button href="https://github.com/eariassoto/brasm/" target="_blank">Get the code on GitHub</a></p>
</div>


  <footer>
    <p class="meta">
      
  



  <span class="byline author vcard">Authored by <span class="fn">
  
    Emmanuel Arias
  
  </span></span>


      




<time class='entry-date' datetime='2017-05-01T18:38:55-06:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2017</span></span> <span class='time'>6:38 pm</span></time>
      
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://eariassoto.github.io/blog/2017/05/01/source-to-source-compilation-with-lex-yacc/" data-via="" data-counturl="http://eariassoto.github.io/blog/2017/05/01/source-to-source-compilation-with-lex-yacc/" >Tweet</a>
  
  
  
    <div class="fb-like" data-layout="button_count" data-send="false" data-width="300" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/04/17/building-a-basic-c-slash-c-plus-plus-project-template/" title="Previous Post: Building a basic C/C++ project template">&laquo; Building a basic C/C++ project template</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>


</div>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2017 - Emmanuel Arias -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a> | Themed with <a href="https://github.com/lucaslew/whitespace">Whitespace</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'probablyageek';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://eariassoto.github.io/blog/2017/05/01/source-to-source-compilation-with-lex-yacc/';
        var disqus_url = 'http://eariassoto.github.io/blog/2017/05/01/source-to-source-compilation-with-lex-yacc/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>






<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id; js.async = true;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
